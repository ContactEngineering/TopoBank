{% extends 'base.html' %}
{% load static i18n %}
{% load icon_tags %}
{% load guardian_tags %}
{% load surface_tags %}

{% block content-title %}Details for measurement <i>{{ topography.name }}</i>
{% endblock content-title %}

{% block content %}

  {% get_obj_perms request.user for topography.surface as "surface_perms" %}

  <div class="tab-content mt-2 extra-tab">

    <div class="row">

      {# First column: Navigation pills #}
      <div class="col-12 col-sm-4 col-md-3 col-lg-2">
        <div class="nav nav-pills nav-pills-custom flex-column" role="tablist" aria-orientation="vertical">
          <a class="nav-link mb-3 p-3 shadow active" data-toggle="pill" href="#plot" role="tab" aria-selected="true">
            Plot
          </a>
          <a class="nav-link mb-3 p-3 shadow" data-toggle="pill" href="#properties" role="tab" aria-selected="false">
            Properties
          </a>
          <a class="nav-link mb-3 p-3 shadow" data-toggle="pill" href="#instrument" role="tab" aria-selected="false">
            Instrument
          </a>
        </div>
      </div>

      {# Second column: Content for pill selection (first column) #}
      <div class="col-xs-12 col" style="padding-bottom: 7px;">
        <div class="tab-content mt-2">
          {# Plot #}
          <div class="tab-pane fade active show" id="plot" role="tabpanel" aria-labelledby="plot-tab">
            {% if topography.size_y %}
              <div id="topography-container" class="dzi-container" style="min-height: calc(100vh - 240px);">
                <div id="topography-view" class="dzi-view"></div>
                <div id="topography-colorbar" class="dzi-colorbar"></div>
              </div>
            {% else %}
              <div id="topography-plot-content">
                <span class="spinner"></span>Please wait...
              </div>
            {% endif %}
          </div>

          {# Properties #}
          <div class="tab-pane fade" id="properties" role="tabpanel" aria-labelledby="properties-tab">
            <table class="table table-striped table-bordered w-75">
              <caption>Measurement properties</caption>
              <tbody>
              <tr>
                <th scope="row">Measurement date</th>
                <td>{{ topography.measurement_date }}</td>
              </tr>
              <tr>
                <th scope="row">File format</th>
                <td>{{ topography.datafile_format|default_if_none:'(not saved yet - autodetection on every use)' }}</td>
              </tr>
              <tr>
                <th scope="row">Data source</th>
                <td>{{ topography.data_source }}</td>
              </tr>
              <tr>
                <th scope="row">Description</th>
                <td>{{ topography.description }}</td>
              </tr>
              <tr>
                <th scope="row">Physical size</th>
                <td>
                  {{ topography.size_x }} {{ topography.unit }}{% if topography.size_y %} x {{ topography.size_y }} {{ topography.unit }} {% endif %}
                  ({% if topography.size_editable %}given by user{% else %}fixed by file contents{% endif %})
                </td>
              </tr>
              <tr>
                <th scope="row">Periodicity</th>
                <td>
                  This topography is {% if not topography.is_periodic %}not {% endif %}periodic.
                </td>
              </tr>
              <tr>
                <th scope="row">Height conversion factor</th>
                <td>{{ topography.height_scale }} {{ topography.unit }} ({% if topography.height_scale_editable %}given
                  by user{% else %}fixed by file contents{% endif %})
                </td>
              </tr>
              <tr>
                <th scope="row">Undefined/missing data</th>
                <td>{{ topography.get_undefined_data_status }}</td>
              </tr>
              <tr>
                <th scope="row">Detrending mode</th>
                <td>{{ topography.get_detrend_mode_display }}</td>
              </tr>
              <tr>
                <th scope="row">Number of data points</th>
                <td>
                  {% if topography.resolution_x %}
                    {{ topography.resolution_x }}{% if topography.resolution_y %} x {{ topography.resolution_y }}
                    {% endif %}
                  {% else %}
                    (not saved yet)
                  {% endif %}
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          {# instrument #}
          <div class="tab-pane fade" id="instrument" role="tabpanel" aria-labelledby="instrument-tab">
            <table class="table table-striped table-bordered w-75">
              <caption>Instrument properties for this measurement</caption>
              <tbody>
              <tr>
                <th scope="row">Name</th>
                <td>
                  {{ topography.instrument_name | default:"(undefined)" }}
                </td>
              </tr>
              <tr>
                <th scope="row">Type</th>
                <td>{{ topography.get_instrument_type_display }}</td>
              </tr>
              {# Insert parameters as extra lines #}
              {% with topography.instrument_parameters as instrument_params %}
                {% if topography.instrument_type == "microscope-based" %}
                  <tr>
                    <th scope="row">Resolution</th>
                    <td>{{ instrument_params.resolution.value }} {{ instrument_params.resolution.unit }}</td>
                  </tr>
                {% elif topography.instrument_type == "contact-based" %}
                  <tr>
                    <th scope="row">Tip radius</th>
                    <td>{{ instrument_params.tip_radius.value }} {{ instrument_params.tip_radius.unit }}</td>
                  </tr>
                {% endif %}
              {% endwith %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-sm-3 col-12">
        {# Buttons for switching between topographies #}
        <div class="row p-3">
          <div class="col">
            <ul class="nav nav-pills float-right">
              <li>
                <div class="btn-group">
                  <a href="{% url 'manager:topography-detail' topography_prev %}"
                     class="btn btn-default {% if topography_prev == topography.id %} disabled {% endif %}"
                     data-toggle="tooltip" title="previous topography of related surface">
                    {% fa5_icon 'chevron-left' %}
                  </a>
                  <a href="{% url 'manager:topography-detail' topography_next %}"
                     class="btn btn-default {% if topography_next == topography.id %} disabled {% endif %}"
                     data-toggle="tooltip" title="next topography of related surface">
                    {% fa5_icon 'chevron-right' %}
                  </a>
                </div>
              </li>
            </ul>
          </div>
        </div>
        {# Badges and tags in a card #}
        <div class="row p-3">
          <div class="col">
            <div class="card-sm">
              <div class="card-body">
                {% render_uploaded_by_badge request topography %}
                {% for tag in topography.tags.all %}
                  <span class="badge badge-success">{{ tag.name }}</span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {# Buttons #}
        <div class="row p-3">
          <div class="col">
            <a href="{% url 'analysis:topography' topography.id %}" class="btn btn-default btn-block btn-lg">
              {% fa5_icon 'chart-area' %} Analyze this measurement
            </a>
            {% if "change_surface" in surface_perms %}
              <a href="{% url 'manager:topography-update' topography.id %}"
                 class="btn btn-default btn-block btn-lg">
                {% fa5_icon 'edit' %} Edit
              </a>
            {% endif %}

            <a id="topography-download" href="#" class="btn btn-default btn-block btn-lg">
              {% fa5_icon 'download' %} Download as PNG
            </a>

            {% if "change_surface" in surface_perms %}
              <a href="{% url 'manager:topography-delete' topography.id %}"
                 class="btn btn-outline-danger btn-block btn-lg">
                {% fa5_icon 'trash' %} Delete
              </a>
            {% endif %}
          </div>
        </div>
      </div>

    </div>


  </div>


{% endblock content %}

{% block javascript %}

  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-2.2.3.min.js"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.2.3.min.js"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.2.3.min.js"></script>


  {# Some JSON code to define JS variables from Django context #}
  {{ category_filter_choices | json_script:"category-filter-choices" }}

  {% if topography.size_y %}
    <script>
      $(document).ready(function () {
        // Create array with tick information
        var ticks = [];
        {% for colorbar_tick in dzi_colorbar_ticks %}
          ticks.push({position: '{{ colorbar_tick.0 }}', label: '{{ colorbar_tick.1 }}'});
        {% endfor %}

        // Visualize topography map
        visualizeMap(
          'topography-view',
          "{% url 'manager:topography-dzi' pk=topography.id dzi_filename='' %}",
          'topography-colorbar',
          'topography-download');
      });
    </script>
  {% else %}
    <script>
      $(document).ready(function () {
        /** Triggering loading of bokeh plot */
        console.log("Requesting plot via AJAX call..");
        $.ajax({
          url: "{% url 'manager:topography-plot' topography.pk %}",
          type: 'get',
          success: function (data) {
            // server returns rendered "topography_plot.html"
            // which is just pure html, use this to replace the existing
            // html within the "plot content" div
            console.log("Plot data received. Inserting plot..");
            $('#topography-plot-content').html(data);
            console.log("Plot inserted.")
          },
          error: function (xhr, textStatus, errorThrown) {
            /**
             * If an error occurs *not* because of XMLHttpRequest.abort(), show an
             * error message. Do not show error on .abort(). See also
             * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/abort
             * */
            if (xhr.status == 0) {
              console.log("Canceled plot generation.");
              $('#topography-plot-content').html(`
                    Canceled loading of plot.
                  `)
            } else {
              console.error("Could not create plot: " + errorThrown + " " + xhr.status + " " + xhr.responseText);
              $('#topography-plot-content').html(`
                    <div class='alert alert-danger'>
                        Could not request plot data. Error: ${errorThrown}
                    </div>
                  `);
            }
          }
        });
      });
    </script>
  {% endif %}

{% endblock %}

