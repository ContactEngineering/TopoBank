{% extends 'base.html' %}
{% load fontawesome %}
{% load surface_tags %}
{% load guardian_tags %}
{% load static %}
{% load render_table from django_tables2 %}


{% block content %}

  {% get_obj_perms request.user for instrument as "instrument_perms" %}

  <div class="tab-content pt-2 extra-tab">

      <div class="row">

        <div class="col-12 col-sm-4 col-md-3 col-lg-2">

          <div class="nav nav-pills nav-pills-custom flex-column" aria-orientation="vertical">
              <a class="nav-link mb-3 p-3 shadow active" data-toggle="pill" href="#info" role="tab" aria-selected="true">
                General information
              </a>
              <a class="nav-link mb-3 p-3 shadow" data-toggle="pill" href="#parameters" role="tab" aria-selected="false">
                Default Parameters
              </a>
              <a class="nav-link mb-3 p-3 shadow" data-toggle="pill" href="#measurements" role="tab" aria-selected="false">
                Measurements
              </a>
              <a class="nav-link mb-3 p-3 shadow" data-toggle="pill" href="#permissions" role="tab" aria-selected="false">
                Permissions
              </a>
          </div>
        </div>

        <div class="col-12 col-sm-5 col-md-6 col-lg-7">

          <div class="tab-content rounded tab-content-vertical-tabs">

            <div class="tab-pane p-2 fade active show" id="info">
              <table class="table table-striped table-bordered w-75">
                <caption>General information about the instrument</caption>
                <tbody>
                <tr>
                  <th scope="row">Type of instrument</th>
                  <td>{{ instrument.get_type_display }}</td>
                </tr>
                <tr>
                  <th scope="row">Description</th>
                  <td>{{ instrument.description|default:"(no description given)" }}</td>
                </tr>
                </tbody>
              </table>
            </div>

            <div class="tab-pane fade" id="parameters">
              <div class="alert alert-info w-75">
                These parameters will be used as template for the parameters of new measurements
                which use this instrument. Afterwards they can be adjusted when editing the measurement.
              </div>
              {% if instrument.parameters %}
              <table class="table table-striped table-bordered w-75">
                <caption>Default parameters for new measurements</caption>
                <tbody>
                {% if 'resolution' in instrument.parameters %}
                <tr>
                  <th scope="row">Resolution</th>
                  <td>{{ instrument.parameters.resolution.value }} {{ instrument.parameters.resolution.unit }}</td>
                </tr>
                {% endif %}
                {% if 'tip_radius' in instrument.parameters %}
                <tr>
                  <th scope="row">Tip radius</th>
                  <td>{{ instrument.parameters.tip_radius.value }} {{ instrument.parameters.tip_radius.unit }}</td>
                </tr>
                {% endif %}
                </tbody>
              </table>
              {% else %}
                (no specific parameters)
              {% endif %}
            </div>

            <div class="tab-pane p-2 fade" id="measurements">
              {% if instrument.topography_set.count > 0 %}
                <div class="alert alert-info">These measurements have been marked with this instrument.</div>
                {% render_table topography_list_table %}
              {% else %}
                <div class="alert alert-info">No measurements have been marked with this instrument yet.
                You can choose this instrument when editing a measurement. The default parameters of
                this instrument will be copied as parameters of the measurement. This copy can then
                be edited individually for each measurement.
                </div>
              {% endif %}
            </div>

            <div class="tab-pane p-2 fade" id="permissions">

              <table class="table table-responsive">
                <caption>Users having permissions regarding this instrument.
                  <!-- Click <a href="{% url 'manager:sharing-info' %}">here</a> for information which instruments are
                  shared with you or by you. -->
                </caption>
                <thead>
                {% for th in permission_table.head %}
                  <th>{{ th }}</th>
                {% endfor %}
                </thead>
                <tbody>

                {% for row in permission_table.body %}
                  <tr>
                    {% for cell_content, cell_title in row %}
                      <td>
                        {% if forloop.first %}
                          <span title="Click to view profile">{% fontawesome_icon 'user' %}
                            <a href="{{ cell_title }}">{{ cell_content }}</a>
                            {# a bit of a hack: cell_title is used to pass a link here #}
                          </span>
                        {% else %}
                          {% render_boolean cell_content cell_title %}
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}

                </tbody>
              </table>

            </div>

          </div>

        </div>

        {# Sidebar with buttons and information #}
        <div class="col-12 col-sm-3 col-md-3 col-lg-3">

          {# Buttons #}
          <div class="row p-3">
            <div class="col">

              {% if "change_instrument" in instrument_perms %}
                <a href="{% url 'manager:instrument-update' instrument.id %}" class="btn btn-default btn-block btn-lg">
                  {% fontawesome_icon 'edit' %} Edit
                </a>
              {% endif %}

              {% if "share_instrument" in instrument_perms %}
                <a href="{% url 'manager:instrument-share' instrument.id %}" class="btn btn-default btn-block btn-lg">
                  {% fontawesome_icon 'share-alt' %} Share
                </a>
              {% endif %}

              {% if "delete_instrument" in instrument_perms %}
                <a href="{% url 'manager:instrument-delete' instrument.id %}"
                   class="btn btn-outline-danger btn-block btn-lg">
                  {% fontawesome_icon 'trash' %} Delete
                </a>
              {% endif %}
            </div>
          </div>
        </div>

      </div>

  </div>

{% endblock content %}
